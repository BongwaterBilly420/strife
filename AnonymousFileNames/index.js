(function(_,U,E,y,I,K,D,Q,g,N,m){"use strict";const V=N.findByCodeLazy("UPLOAD_FILE_LIMIT_ERROR"),O=N.findStoreLazy("UserSettingsProtoStore"),j=N.findLazy(function(e){return e.ProtoClass?.typeName==="discord_protos.discord_users.v1.PreloadedUserSettings"}),v=N.findByPropsLazy("readerFactory"),S=N.findStoreLazy("StickersStore");function B(e,t){if(!t)return;const n=t.fields.find(function(i){return i.localName===e});return n?Object.values(n).find(function(i){return typeof i=="function"})?.():void 0}const k=D.proxyLazy(function(){return B("appearance",j.ProtoClass)}),P=D.proxyLazy(function(){return B("clientThemeSettings",k)}),q=1n<<18n,H=1n<<37n;var M;(function(e){e[e.REACTION=0]="REACTION",e[e.STATUS=1]="STATUS",e[e.COMMUNITY_CONTENT=2]="COMMUNITY_CONTENT",e[e.CHAT=3]="CHAT",e[e.GUILD_STICKER_RELATED_EMOJI=4]="GUILD_STICKER_RELATED_EMOJI",e[e.GUILD_ROLE_BENEFIT_EMOJI=5]="GUILD_ROLE_BENEFIT_EMOJI",e[e.COMMUNITY_CONTENT_ONLY=6]="COMMUNITY_CONTENT_ONLY",e[e.SOUNDBOARD=7]="SOUNDBOARD"})(M||(M={}));var w;(function(e){e[e.PNG=1]="PNG",e[e.APNG=2]="APNG",e[e.LOTTIE=3]="LOTTIE",e[e.GIF=4]="GIF"})(w||(w={}));const R=/\/emojis\/(\d+?)\.(png|webp|gif)/,b=/\/stickers\/(\d+?)\./,C=/\/attachments\/\d+?\/\d+?\/(\d+?)\.gif/,o=E.definePluginSettings({enableEmojiBypass:{description:"Allow sending fake emojis",type:g.OptionType.BOOLEAN,default:!0,restartNeeded:!0},emojiSize:{description:"Size of the emojis when sending",type:g.OptionType.SLIDER,default:48,markers:[32,48,64,128,160,256,512]},transformEmojis:{description:"Whether to transform fake emojis into real ones",type:g.OptionType.BOOLEAN,default:!0,restartNeeded:!0},enableStickerBypass:{description:"Allow sending fake stickers",type:g.OptionType.BOOLEAN,default:!0,restartNeeded:!0},stickerSize:{description:"Size of the stickers when sending",type:g.OptionType.SLIDER,default:160,markers:[32,64,128,160,256,512]},transformStickers:{description:"Whether to transform fake stickers into real ones",type:g.OptionType.BOOLEAN,default:!0,restartNeeded:!0},transformCompoundSentence:{description:"Whether to transform fake stickers and emojis in compound sentences (sentences with more content than just the fake emoji or sticker link)",type:g.OptionType.BOOLEAN,default:!1},enableStreamQualityBypass:{description:"Allow streaming in nitro quality",type:g.OptionType.BOOLEAN,default:!0,restartNeeded:!0}});var Y=g({name:"FakeNitro",authors:[y.Devs.Arjix,y.Devs.D3SOX,y.Devs.Ven,y.Devs.obscurity,y.Devs.captain,y.Devs.Nuckyz,y.Devs.AutumnVN],description:"Allows you to stream in nitro quality, send fake emojis/stickers and use client themes.",dependencies:["MessageEventsAPI"],settings:o,patches:[{find:".PREMIUM_LOCKED;",predicate:function(){return o.store.enableEmojiBypass},replacement:[{match:/(?<=(\i)=\i\.intention)/,replace:function(e,t){return`,fakeNitroIntention=${t}`}},{match:/\.(?:canUseEmojisEverywhere|canUseAnimatedEmojis)\(\i(?=\))/g,replace:'$&,typeof fakeNitroIntention!=="undefined"?fakeNitroIntention:void 0'},{match:/(&&!\i&&)!(\i)(?=\)return \i\.\i\.DISALLOW_EXTERNAL;)/,replace:function(e,t,n){return`${t}(!${n}&&(typeof fakeNitroIntention==="undefined"||![${3},${4}].includes(fakeNitroIntention)))`}},{match:/if\(!\i\.available/,replace:function(e){return`${e}&&(typeof fakeNitroIntention==="undefined"||![${3},${4}].includes(fakeNitroIntention))`}}]},{find:"canUseAnimatedEmojis:function",predicate:function(){return o.store.enableEmojiBypass},replacement:{match:/((?:canUseEmojisEverywhere|canUseAnimatedEmojis):function\(\i)\){(.+?\))/g,replace:function(e,t,n){return`${t},fakeNitroIntention){${n}||fakeNitroIntention==null||[${3},${4}].includes(fakeNitroIntention)`}}},{find:"canUseStickersEverywhere:function",predicate:function(){return o.store.enableStickerBypass},replacement:{match:/canUseStickersEverywhere:function\(\i\){/,replace:"$&return true;"}},{find:'"SENDABLE"',predicate:function(){return o.store.enableStickerBypass},replacement:{match:/(\w+)\.available\?/,replace:"true?"}},{find:"canStreamHighQuality:function",predicate:function(){return o.store.enableStreamQualityBypass},replacement:["canUseHighVideoUploadQuality","canStreamHighQuality","canStreamMidQuality"].map(function(e){return{match:new RegExp(`${e}:function\\(\\i\\){`),replace:"$&return true;"}})},{find:"STREAM_FPS_OPTION.format",predicate:function(){return o.store.enableStreamQualityBypass},replacement:{match:/(userPremiumType|guildPremiumTier):.{0,10}TIER_\d,?/g,replace:""}},{find:"canUseClientThemes:function",replacement:{match:/canUseClientThemes:function\(\i\){/,replace:"$&return true;"}},{find:'.displayName="UserSettingsProtoStore"',replacement:[{match:/CONNECTION_OPEN:function\((\i)\){/,replace:function(e,t){return`${e}$self.handleProtoChange(${t}.userSettingsProto,${t}.user);`}},{match:/=(\i)\.local;/,replace:function(e,t){return`${e}${t}.local||$self.handleProtoChange(${t}.settings.proto);`}}]},{find:"updateTheme:function",replacement:{match:/(function \i\(\i\){var (\i)=\i\.backgroundGradientPresetId.+?)(\i\.\i\.updateAsync.+?theme=(.+?);.+?\),\i\))/,replace:function(e,t,n,i,a){return`${t}$self.handleGradientThemeSelect(${n},${a},()=>${i});`}}},{find:'["strong","em","u","text","inlineCode","s","spoiler"]',replacement:[{predicate:function(){return o.store.transformEmojis},match:/1!==(\i)\.length\|\|1!==\i\.length/,replace:function(e,t){return`${e}||$self.shouldKeepEmojiLink(${t}[0])`}},{predicate:function(){return o.store.transformEmojis||o.store.transformStickers},match:/(?=return{hasSpoilerEmbeds:\i,content:(\i)})/,replace:function(e,t){return`${t}=$self.patchFakeNitroEmojisOrRemoveStickersLinks(${t},arguments[2]?.formatInline);`}}]},{find:"renderEmbeds=function",replacement:[{predicate:function(){return o.store.transformEmojis||o.store.transformStickers},match:/(renderEmbeds=function\((\i)\){)(.+?embeds\.map\(\(function\((\i)\){)/,replace:function(e,t,n,i,a){return`${t}const fakeNitroMessage=${n};${i}if($self.shouldIgnoreEmbed(${a},fakeNitroMessage))return null;`}},{predicate:function(){return o.store.transformStickers},match:/renderStickersAccessories=function\((\i)\){var (\i)=\(0,\i\.\i\)\(\i\),/,replace:function(e,t,n){return`${e}${n}=$self.patchFakeNitroStickers(${n},${t}),`}},{predicate:function(){return o.store.transformStickers},match:/renderAttachments=function\(\i\){var (\i)=\i.attachments.+?;/,replace:function(e,t){return`${e}${t}=$self.filterAttachments(${t});`}}]},{find:".STICKER_IN_MESSAGE_HOVER,",predicate:function(){return o.store.transformStickers},replacement:[{match:/var (\i)=\i\.renderableSticker,.{0,50}closePopout.+?channel:\i,closePopout:\i,/,replace:function(e,t){return`${e}renderableSticker:${t},`}},{match:/(emojiSection.{0,50}description:)(\i)(?<=(\i)\.sticker,.+?)(?=,)/,replace:function(e,t,n,i){return`${t}$self.addFakeNotice("STICKER",${n},!!${i}.renderableSticker?.fake)`}}]},{find:".Messages.EMOJI_POPOUT_PREMIUM_JOINED_GUILD_DESCRIPTION",predicate:function(){return o.store.transformEmojis},replacement:{match:/((\i)=\i\.node,\i=\i\.emojiSourceDiscoverableGuild)(.+?return )(.{0,450}Messages\.EMOJI_POPOUT_PREMIUM_JOINED_GUILD_DESCRIPTION.+?}\))/,replace:function(e,t,n,i,a){return`${t},fakeNitroNode=${n}${i}$self.addFakeNotice("EMOJI",${a},fakeNitroNode.fake)`}}}],get guildId(){return K.getCurrentGuild()?.id},get canUseEmotes(){return(m.UserStore.getCurrentUser().premiumType??0)>0},get canUseStickers(){return(m.UserStore.getCurrentUser().premiumType??0)>1},handleProtoChange(e,t){if(!(e==null||typeof e=="string"||!O||!e.appearance&&!k)&&(t?.premium_type??m.UserStore?.getCurrentUser()?.premiumType??0)!==2&&(e.appearance??=k.create(),O.settings.appearance?.theme!=null&&(e.appearance.theme=O.settings.appearance.theme),O.settings.appearance?.clientThemeSettings?.backgroundGradientPresetId?.value!=null&&P)){const n=P.create({backgroundGradientPresetId:{value:O.settings.appearance.clientThemeSettings.backgroundGradientPresetId.value}});e.appearance.clientThemeSettings??=n,e.appearance.clientThemeSettings.backgroundGradientPresetId=n.backgroundGradientPresetId}},handleGradientThemeSelect(e,t,n){if((m.UserStore?.getCurrentUser()?.premiumType??0)===2||e==null)return n();if(!k||!P||!v)return;const i=j.getCurrentValue().appearance,a=i!=null?k.fromBinary(k.toBinary(i),v):k.create();a.theme=t;const d=P.create({backgroundGradientPresetId:{value:e}});a.clientThemeSettings??=d,a.clientThemeSettings.backgroundGradientPresetId=d.backgroundGradientPresetId;const l=j.ProtoClass.create();l.appearance=a,m.FluxDispatcher.dispatch({type:"USER_SETTINGS_PROTO_UPDATE",local:!0,partial:!0,settings:{type:1,proto:l}})},trimContent(e){const t=e[0];typeof t=="string"&&(e[0]=t.trimStart()),e[0]===""&&e.shift();const n=e.length-1,i=e[n];typeof i=="string"&&(e[n]=i.trimEnd()),e[n]===""&&e.pop()},clearEmptyArrayItems(e){return e.filter(function(t){return t!=null})},ensureChildrenIsArray(e){Array.isArray(e.props.children)||(e.props.children=[e.props.children])},patchFakeNitroEmojisOrRemoveStickersLinks(e,t){var n=this;if((e.length>1||typeof e[0]?.type=="string")&&!o.store.transformCompoundSentence)return e;let i=e.length;const a=function(r){if(o.store.transformEmojis){const s=r.props.href.match(R);if(s){let f=null;try{f=new URL(r.props.href)}catch{}const p=m.EmojiStore.getCustomEmojiById(s[1])?.name??f?.searchParams.get("name")??"FakeNitroEmoji";return m.Parser.defaultRules.customEmoji.react({jumboable:!t&&e.length===1&&typeof e[0].type!="string",animated:s[2]==="gif",emojiId:s[1],name:p,fake:!0},void 0,{key:String(i++)})}}if(o.store.transformStickers){if(b.test(r.props.href))return null;const s=r.props.href.match(C);if(s&&S.getStickerById(s[1]))return null}return r},d=function(r){return r?.props?.trusted!=null?a(r):r?.props?.children!=null?Array.isArray(r.props.children)?(r.props.children=c(r.props.children),r.props.children.length===0?null:r):(r.props.children=l(r.props.children),r):r},l=function(r){const s=d(r);if(s?.type==="ul"||s?.type==="ol"){if(n.ensureChildrenIsArray(s),s.props.children.length===0)return null;let f=!1;for(const[p,u]of s.props.children.entries()){if(u==null){delete s.props.children[p];continue}n.ensureChildrenIsArray(u),u.props.children.length>0?f=!0:delete s.props.children[p]}if(!f)return null;s.props.children=n.clearEmptyArrayItems(s.props.children)}return s},c=function(r){for(const[s,f]of r.entries())r[s]=l(f);return r=n.clearEmptyArrayItems(r),n.trimContent(r),r};try{return c(window._.cloneDeep(e))}catch(r){return new Q.Logger("FakeNitro").error(r),e}},patchFakeNitroStickers(e,t){const n=[],i=t.content.split(/\s/);o.store.transformCompoundSentence?n.push(...i):i.length===1&&n.push(i[0]),n.push(...t.attachments.filter(function(a){return a.content_type==="image/gif"}).map(function(a){return a.url}));for(const a of n){if(!o.store.transformCompoundSentence&&!a.startsWith("http"))continue;const d=a.match(b);if(d){let c=null;try{c=new URL(a)}catch{}const r=S.getStickerById(d[1])?.name??c?.searchParams.get("name")??"FakeNitroSticker";e.push({format_type:1,id:d[1],name:r,fake:!0});continue}const l=a.match(C);if(l){if(!S.getStickerById(l[1]))continue;const c=S.getStickerById(l[1])?.name??"FakeNitroSticker";e.push({format_type:2,id:l[1],name:c,fake:!0})}}return e},shouldIgnoreEmbed(e,t){const n=t.content.split(/\s/);if(n.length>1&&!o.store.transformCompoundSentence)return!1;switch(e.type){case"image":{if(!o.store.transformCompoundSentence&&!n.includes(e.url)&&!n.includes(e.image.proxyURL))return!1;if(o.store.transformEmojis&&R.test(e.url))return!0;if(o.store.transformStickers){if(b.test(e.url))return!0;const i=e.url.match(C);if(i&&S.getStickerById(i[1]))return!0}break}}return!1},filterAttachments(e){return e.filter(function(t){if(t.content_type!=="image/gif")return!0;const n=t.url.match(C);return!(n&&S.getStickerById(n[1]))})},shouldKeepEmojiLink(e){return e.target&&R.test(e.target)},addFakeNotice(e,t,n){if(!n)return t;switch(t=Array.isArray(t)?t:[t],e){case"STICKER":return t.push(" This is a FakeNitro sticker and renders like a real sticker only for you. Appears as a link to non-plugin users."),t;case"EMOJI":return t.push(" This is a FakeNitro emoji and renders like a real emoji only for you. Appears as a link to non-plugin users."),t}},hasPermissionToUseExternalEmojis(e){const t=m.ChannelStore.getChannel(e);return!t||t.isDM()||t.isGroupDM()||t.isMultiUserDM()?!0:m.PermissionStore.can(q,t)},hasPermissionToUseExternalStickers(e){const t=m.ChannelStore.getChannel(e);return!t||t.isDM()||t.isGroupDM()||t.isMultiUserDM()?!0:m.PermissionStore.can(H,t)},getStickerLink(e){return`https://media.discordapp.net/stickers/${e}.png?size=${E.Settings.plugins.FakeNitro.stickerSize}`},async sendAnimatedSticker(e,t,n){const[{parseURL:i},{GIFEncoder:a,quantize:d,applyPalette:l}]=await Promise.all([I.importApngJs(),I.getGifEncoder()]),{frames:c,width:r,height:s}=await i(e),f=new a,p=E.Settings.plugins.FakeNitro.stickerSize,u=document.createElement("canvas");u.width=p,u.height=p;const h=u.getContext("2d",{willReadFrequently:!0}),G=p/Math.max(r,s);h.scale(G,G);let F;for(const X of c){const{left:T,top:$,width:A,height:L,img:Z,delay:ee,blendOp:te,disposeOp:z}=X;F=h.getImageData(T,$,A,L),te===I.ApngBlendOp.SOURCE&&h.clearRect(T,$,A,L),h.drawImage(Z,T,$,A,L);const{data:x}=h.getImageData(0,0,p,p),J=d(x,256),ne=l(x,J);f.writeFrame(ne,p,p,{transparent:!0,palette:J,delay:ee}),z===I.ApngDisposeOp.BACKGROUND?h.clearRect(T,$,A,L):z===I.ApngDisposeOp.PREVIOUS&&h.putImageData(F,T,$)}f.finish();const W=new File([f.bytesView()],`${t}.gif`,{type:"image/gif"});V([W],m.ChannelStore.getChannel(n),0)},start(){var e=this;const t=o.store;if(!t.enableEmojiBypass&&!t.enableStickerBypass)return;function n(i,a){return!i[a]||/\s/.test(i[a])?"":" "}this.preSend=U.addPreSendListener(function(i,a,d){const{guildId:l}=e;e:{if(!t.enableStickerBypass)break e;const c=S.getStickerById(d.stickers?.[0]);if(!c||"pack_id"in c)break e;const r=e.canUseStickers&&e.hasPermissionToUseExternalStickers(i);if(c.available!==!1&&(r||c.guild_id===l))break e;const s=e.getStickerLink(c.id);if(c.format_type===2)return e.sendAnimatedSticker(s,c.id,i),{cancel:!0};d.stickers.length=0,a.content+=` ${s}&name=${encodeURIComponent(c.name)}`}if(t.enableEmojiBypass){const c=e.canUseEmotes&&e.hasPermissionToUseExternalEmojis(i);for(const r of a.validNonShortcutEmojis){if(!r.require_colons||r.available!==!1&&c||r.guildId===l&&!r.animated)continue;const s=`<${r.animated?"a":""}:${r.originalName||r.name}:${r.id}>`,f=r.url.replace(/\?size=\d+/,"?"+new URLSearchParams({size:E.Settings.plugins.FakeNitro.emojiSize,name:encodeURIComponent(r.name)}));a.content=a.content.replace(s,function(p,u,h){return`${n(h,u-1)}${f}${n(h,u+p.length)}`})}}return{cancel:!1}}),this.preEdit=U.addPreEditListener(function(i,a,d){if(!t.enableEmojiBypass)return;const l=e.canUseEmotes&&e.hasPermissionToUseExternalEmojis(i),{guildId:c}=e;d.content=d.content.replace(/(?<!\\)<a?:(?:\w+):(\d+)>/ig,function(r,s,f,p){const u=m.EmojiStore.getCustomEmojiById(s);if(u==null||!u.require_colons||u.available!==!1&&l||u.guildId===c&&!u.animated)return r;const h=u.url.replace(/\?size=\d+/,"?"+new URLSearchParams({size:E.Settings.plugins.FakeNitro.emojiSize,name:encodeURIComponent(u.name)}));return`${n(p,f-1)}${h}${n(p,f+r.length)}`})})},stop(){U.removePreSendListener(this.preSend),U.removePreEditListener(this.preEdit)}});return _.default=Y,Object.defineProperty(_,"__esModule",{value:!0}),_})({},MessageEvents,Settings,constants,dependencies,discord,lazy,Logger,ce,_webpack,common);
