(function(y,a,E,i,t,M,w,S,v,h,b,O,V){"use strict";const A="915703782174752809",R="https://manti.vendicated.dev",c=R+"/api/reviewdb";var Y=Object.freeze({__proto__:null,API_URL:c,BASE_URL:R,CLIENT_ID:A});const{getCurrentUser:I}=i.findByStoreName("UserStore"),D=function(e){return e.sender.discordID===I()?.id||g.includes(I()?.id)};async function l(e,n){const r=await fetch(e,n);if(!r.ok)throw new Error("Request returned non-ok");const o=await r.json();if(o.success===!1)throw new Error(o.message);return o}var J=Object.freeze({__proto__:null,canDeleteReview:D,jsonFetch:l});const C=async function(e){return(await l(c+`/users/${e}/reviews`)).reviews},N=async function(){return await l(R+"/admins")},P=async function(e,n){return await l(c+`/users/${e}/reviews`,{method:"PUT",body:JSON.stringify({comment:n,token:a.storage.authToken}),headers:{"content-type":"application/json",accept:"application/json"}})},B=async function(e,n){return await l(c+`/users/${e}/reviews`,{method:"DELETE",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify({reviewid:n,token:a.storage.authToken})})},_=async function(e){return await l(c+"/reports",{method:"PUT",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify({reviewid:e,token:a.storage.authToken})})};async function X(e){const n=await E.safeFetch(c+"/getLastReviewID?discordid="+e,{});return Number(await n.text())}var H=Object.freeze({__proto__:null,addReview:P,deleteReview:B,getAdmins:N,getLastReviewID:X,getReviews:C,reportReview:_});const{hideActionSheet:q}=i.findByProps("openLazy","hideActionSheet"),{showSimpleActionSheet:G}=i.findByProps("showSimpleActionSheet");function x(e){return G({key:"ReviewOverflow",header:{title:e.type!==3?`Review by ${e.sender.username}`:"ReviewDB System Message",onClose:function(){return q()}},options:[{label:"Copy Text",onPress:function(){t.clipboard.setString(e.comment),v.showToast("Copied Review Text",h.getAssetIDByName("ic_message_copy"))}},...a.storage.authToken&&e.type!==3?[...D(e)?[{label:"Delete Review",isDestructive:!0,onPress:function(){return S.showConfirmationAlert({title:"Delete Review",content:"Are you sure you want to delete this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return B(e.sender.discordID,e.id)}})}}]:[],{label:"Report Review",isDestructive:!0,onPress:function(){return S.showConfirmationAlert({title:"Report Review",content:"Are you sure you want to report this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return _(e.id)}})}}]:[]]})}const K=t.stylesheet.createThemedStyleSheet({avatar:{height:36,width:36,borderRadius:18}}),{FormRow:Q,FormLabel:W,FormSubLabel:Z}=w.Forms,{colors:ee,meta:te}=i.findByProps("colors","meta"),ne=i.findByProps("useThemeContext").useThemeContext;function re(e){let{review:n}=e;const r=ne(),o=te.resolveSemanticColor(r.theme,ee.TEXT_NORMAL);return React.createElement(Q,{label:React.createElement(W,{text:n.sender.username,style:{color:o}}),subLabel:React.createElement(Z,{text:n.comment,style:{color:o}}),leading:React.createElement(t.ReactNative.Image,{style:K.avatar,source:{uri:n.sender.profilePhoto}}),onLongPress:function(){return x(n)}})}const m=t.stylesheet.createThemedStyleSheet({container:{flex:1,flexDirection:"row",alignItems:"center",justifyContent:"center",marginHorizontal:4},textInput:{flex:1,flexGrow:1,fontSize:16,fontFamily:t.constants.Fonts.DISPLAY_MEDIUM},sendButton:{flexShrink:0,flexDirection:"row",alignItems:"center",justifyContent:"center",backgroundColor:O.rawColors.BRAND_500,height:40,width:40,borderRadius:20,marginLeft:4}}),{colors:L,meta:k}=i.findByProps("colors","meta"),oe=i.findByProps("useThemeContext").useThemeContext;function ae(e){let{userId:n,shouldEdit:r,refetch:o}=e;b.useProxy(a.storage);const s=oe(),u=k.resolveSemanticColor(s.theme,L.TEXT_NORMAL),d=k.resolveSemanticColor(s.theme,L.INPUT_PLACEHOLDER_TEXT),[T,j]=t.React.useState(""),z=!a.storage.authToken,F=!a.storage.authToken||T.length===0;return t.React.createElement(t.ReactNative.View,{style:m.container},t.React.createElement(t.ReactNative.TextInput,{style:{...m.textInput,color:u},editable:!z,placeholder:z?"You must be authenticated to add a review.":`Tap to ${r?"edit your":"add a"} review`,placeholderTextColor:d,value:T,onChangeText:function(p){return j(p)}}),t.React.createElement(t.ReactNative.Pressable,{style:{...m.sendButton,opacity:F?.25:1},disabled:F,onPress:function(){P(n,T).then(function(p){j(""),o(),v.showToast(p.message,h.getAssetIDByName("Check"))}).catch(function(p){return v.showToast(p,h.getAssetIDByName("Small"))})}},t.React.createElement(t.ReactNative.Image,{style:{tintColor:"#fff"},source:h.getAssetIDByName("ic_send")})))}const{getCurrentUser:ie}=i.findByStoreName("UserStore"),se=i.findByName("UserProfileSection");function ce(e){let{userId:n}=e;const[r,o]=t.React.useState([]),s=function(){C(n).then(function(d){return o(d)})};t.React.useEffect(s,[]);const u=r.filter(function(d){return d.sender.discordID===ie()?.id}).length!==0;return t.React.createElement(w.ErrorBoundary,null,t.React.createElement(se,{title:"Reviews",showContainer:!0},t.React.createElement(t.ReactNative.View,{style:{flex:1}},r.map(function(d){return t.React.createElement(re,{review:d})})),t.React.createElement(ae,{userId:n,refetch:s,shouldEdit:u})))}const le=i.find(function(e){return e.type?.name==="UserProfile"});function ue(){return M.after("type",le,function(e,n){const r=E.findInReactTree(n,function(s){return s?.props?.children.find(function(u){return typeof u?.props?.displayProfile?.userId=="string"})&&s?.type?.displayName==="View"&&Array?.isArray(s?.props?.style)})?.props?.children,o=e[0].userId;r?.push(t.React.createElement(ce,{userId:o}))})}const{pushModal:de,popModal:U}=i.findByProps("pushModal"),he=i.findByName("OAuth2AuthorizeModal");function $(){return de({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:he,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:A,redirectUri:c+"/auth",scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function(e){let{location:n}=e;try{const r=new URL(n);r.searchParams.append("returnType","json"),r.searchParams.append("clientMod","vendetta");const{token:o,success:s,message:u}=await l(r,{headers:{accept:"application/json"}});if(s)a.storage.authToken=o;else throw U("oauth2-authorize"),new Error(u)}catch(r){V.logger.error("Authorization failed!",r)}},dismissOAuthModal:function(){return U("oauth2-authorize")}},closable:!0}})}function fe(){return globalThis.vendettaRDB={api:H,utils:{...J,showAuthModal:$,showReviewActionSheet:x},constants:Y},function(){return delete globalThis.vendettaRDB}}const{FormSection:pe,FormRow:f}=w.Forms;function ye(){return b.useProxy(a.storage),React.createElement(t.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},React.createElement(pe,{title:"Authentication",titleStyleType:"no_border"},React.createElement(f,{label:"Authenticate with ReviewDB",leading:React.createElement(f.Icon,{source:h.getAssetIDByName("copy")}),trailing:f.Arrow,onPress:$}),React.createElement(f,{label:"Log out of ReviewDB",subLabel:"Note that this does not remove ReviewDB from your Authorized Apps page in Discord.",leading:React.createElement(f.Icon,{source:h.getAssetIDByName("ic_logout_24px")}),disabled:a.storage.authToken.length===0,onPress:function(){return a.storage.authToken=""}})))}a.storage.authToken??="";const we=[fe(),ue()],g=[];N().then(function(e){return g.push(...e)});const ve=function(){return we.forEach(function(e){return e()})};return y.admins=g,y.onUnload=ve,y.settings=ye,y})({},vendetta.plugin,vendetta.utils,vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.ui.components,vendetta.ui.alerts,vendetta.ui.toasts,vendetta.ui.assets,vendetta.storage,vendetta.ui,vendetta);
