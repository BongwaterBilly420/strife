(function(w,o,E,a,t,O,R,b,p,h,S,V,X){"use strict";const I="915703782174752809",v="https://manti.vendicated.dev",l=v+"/api/reviewdb";var Y=Object.freeze({__proto__:null,API_URL:l,BASE_URL:v,CLIENT_ID:I});const{getCurrentUser:A}=a.findByStoreName("UserStore"),N=function(e){return e.sender.discordID===A()?.id||g.includes(A()?.id)};async function u(e,n){const r=await(await fetch(e,n)).json();if(r.success===!1)throw new Error(r.message);return r}var J=Object.freeze({__proto__:null,canDeleteReview:N,jsonFetch:u});const C=async function(e){return(await u(l+`/users/${e}/reviews`)).reviews},D=async function(){return await u(v+"/admins")},P=async function(e,n){return await u(l+`/users/${e}/reviews`,{method:"PUT",body:JSON.stringify({comment:n,token:o.storage.authToken}),headers:{"content-type":"application/json",accept:"application/json"}})},B=async function(e,n){return await u(l+`/users/${e}/reviews`,{method:"DELETE",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify({reviewid:n,token:o.storage.authToken})})},_=async function(e){return await u(l+"/reports",{method:"PUT",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify({reviewid:e,token:o.storage.authToken})})};async function H(e){const n=await E.safeFetch(l+"/getLastReviewID?discordid="+e,{});return Number(await n.text())}var G=Object.freeze({__proto__:null,addReview:P,deleteReview:B,getAdmins:D,getLastReviewID:H,getReviews:C,reportReview:_});const{hideActionSheet:q}=a.findByProps("openLazy","hideActionSheet"),{showSimpleActionSheet:K}=a.findByProps("showSimpleActionSheet");function x(e){return K({key:"ReviewOverflow",header:{title:e.type!==3?`Review by ${e.sender.username}`:"ReviewDB System Message",onClose:function(){return q()}},options:[{label:"Copy Text",onPress:function(){t.clipboard.setString(e.comment),p.showToast("Copied Review Text",h.getAssetIDByName("ic_message_copy"))}},...o.storage.authToken&&e.type!==3?[...N(e)?[{label:"Delete Review",isDestructive:!0,onPress:function(){return b.showConfirmationAlert({title:"Delete Review",content:"Are you sure you want to delete this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return B(e.sender.discordID,e.id)}})}}]:[],{label:"Report Review",isDestructive:!0,onPress:function(){return b.showConfirmationAlert({title:"Report Review",content:"Are you sure you want to report this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return _(e.id)}})}}]:[]]})}function Q(e){let{badge:n}=e;return React.createElement(t.ReactNative.Pressable,{style:{marginLeft:4},onPress:function(){p.showToast(n.name,{uri:n.icon})}},React.createElement(t.ReactNative.Image,{source:{uri:n.icon,width:16,height:16}}))}const L=t.stylesheet.createThemedStyleSheet({row:{flexDirection:"row",alignItems:"center"}}),{FormLabel:W}=R.Forms,{colors:Z,meta:ee}=a.findByProps("colors","meta"),{useThemeContext:te}=a.findByProps("useThemeContext");function ne(e){let{username:n,badges:r}=e;const s=te(),i=ee.resolveSemanticColor(s.theme,Z.TEXT_NORMAL);return React.createElement(t.ReactNative.View,{style:L.row},React.createElement(W,{text:n,style:{color:i}}),React.createElement(t.ReactNative.View,{style:L.row},r.map(function(c){return React.createElement(Q,{badge:c})})))}const re=t.stylesheet.createThemedStyleSheet({avatar:{height:36,width:36,borderRadius:18}}),{FormRow:ae,FormSubLabel:oe}=R.Forms,{colors:ie,meta:se}=a.findByProps("colors","meta"),{useThemeContext:ce}=a.findByProps("useThemeContext");function le(e){let{review:n}=e;const r=ce(),s=se.resolveSemanticColor(r.theme,ie.TEXT_NORMAL);return React.createElement(ae,{label:React.createElement(ne,{username:n.sender.username,badges:n.sender.badges}),subLabel:React.createElement(oe,{text:n.comment,style:{color:s}}),leading:React.createElement(t.ReactNative.Image,{style:re.avatar,source:{uri:n.sender.profilePhoto}}),onLongPress:function(){return x(n)}})}const m=t.stylesheet.createThemedStyleSheet({container:{flex:1,flexDirection:"row",alignItems:"center",justifyContent:"center",marginHorizontal:4},textInput:{flex:1,flexGrow:1,fontSize:16,fontFamily:t.constants.Fonts.DISPLAY_MEDIUM},sendButton:{flexShrink:0,flexDirection:"row",alignItems:"center",justifyContent:"center",backgroundColor:V.rawColors.BRAND_500,height:40,width:40,borderRadius:20,marginLeft:4}}),{colors:$,meta:k}=a.findByProps("colors","meta"),{useThemeContext:ue}=a.findByProps("useThemeContext");function de(e){let{userId:n,shouldEdit:r,refetch:s}=e;S.useProxy(o.storage);const i=ue(),c=k.resolveSemanticColor(i.theme,$.TEXT_NORMAL),d=k.resolveSemanticColor(i.theme,$.INPUT_PLACEHOLDER_TEXT),[T,F]=t.React.useState(""),M=!o.storage.authToken,z=!o.storage.authToken||T.length===0;return t.React.createElement(t.ReactNative.View,{style:m.container},t.React.createElement(t.ReactNative.TextInput,{style:{...m.textInput,color:c},editable:!M,placeholder:M?"You must be authenticated to add a review.":`Tap to ${r?"edit your":"add a"} review`,placeholderTextColor:d,value:T,onChangeText:function(y){return F(y)}}),t.React.createElement(t.ReactNative.Pressable,{style:{...m.sendButton,opacity:z?.25:1},disabled:z,onPress:function(){P(n,T).then(function(y){F(""),s(),p.showToast(y.message,h.getAssetIDByName("Check"))}).catch(function(y){return p.showToast(y.message,h.getAssetIDByName("Small"))})}},t.React.createElement(t.ReactNative.Image,{style:{tintColor:"#fff"},source:h.getAssetIDByName("ic_send")})))}const{getCurrentUser:he}=a.findByStoreName("UserStore"),fe=a.findByName("UserProfileSection");function ye(e){let{userId:n}=e;const[r,s]=t.React.useState([]),i=function(){C(n).then(function(d){return s(d)})};t.React.useEffect(i,[]);const c=r.filter(function(d){return d.sender.discordID===he()?.id}).length!==0;return t.React.createElement(R.ErrorBoundary,null,t.React.createElement(fe,{title:"Reviews",showContainer:!0},t.React.createElement(t.ReactNative.View,{style:{flex:1}},r.map(function(d){return t.React.createElement(le,{review:d})})),t.React.createElement(de,{userId:n,refetch:i,shouldEdit:c})))}const we=a.findByTypeName("UserProfile");function Re(){return O.after("type",we,function(e,n){const r=E.findInReactTree(n,function(i){return i?.type?.displayName==="View"&&i?.props?.children.findIndex(function(c){return c?.type?.name==="UserProfileBio"})!==-1})?.props?.children,s=e[0]?.userId;r?.push(t.React.createElement(ye,{userId:s}))})}const{pushModal:pe,popModal:U}=a.findByProps("pushModal"),ve=a.findByName("OAuth2AuthorizeModal");function j(){return pe({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:ve,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:I,redirectUri:l+"/auth",scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function(e){let{location:n}=e;try{const r=new URL(n);r.searchParams.append("returnType","json"),r.searchParams.append("clientMod","vendetta");const{token:s,success:i,message:c}=await u(r,{headers:{accept:"application/json"}});if(i)o.storage.authToken=s;else throw U("oauth2-authorize"),new Error(c)}catch(r){X.logger.error("Authorization failed!",r)}},dismissOAuthModal:function(){return U("oauth2-authorize")}},closable:!0}})}function me(){return globalThis.vendettaRDB={api:G,utils:{...J,showAuthModal:j,showReviewActionSheet:x},constants:Y},function(){return delete globalThis.vendettaRDB}}const{FormSection:ge,FormRow:f,FormDivider:Te}=R.Forms;function Ee(){return S.useProxy(o.storage),React.createElement(t.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},React.createElement(ge,{title:"Authentication",titleStyleType:"no_border"},React.createElement(f,{label:"Authenticate with ReviewDB",leading:React.createElement(f.Icon,{source:h.getAssetIDByName("copy")}),trailing:f.Arrow,onPress:j}),React.createElement(Te,null),React.createElement(f,{label:"Log out of ReviewDB",subLabel:"Note that this does not remove ReviewDB from your Authorized Apps page in Discord.",leading:React.createElement(f.Icon,{source:h.getAssetIDByName("ic_logout_24px")}),disabled:o.storage.authToken.length===0,onPress:function(){return o.storage.authToken=""}})))}o.storage.authToken??="";const be=[me(),Re()],g=[];D().then(function(e){return g.push(...e)});const Se=function(){return be.forEach(function(e){return e()})};return w.admins=g,w.onUnload=Se,w.settings=Ee,w})({},vendetta.plugin,vendetta.utils,vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.ui.components,vendetta.ui.alerts,vendetta.ui.toasts,vendetta.ui.assets,vendetta.storage,vendetta.ui,vendetta);
