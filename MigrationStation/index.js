(function(w,i,g,n,f,r,c,v,p,h,o,d){"use strict";const{launchImageLibrary:P}=g.findByProps("launchImageLibrary");g.findByProps("downloadMediaAsset");const B=function(){return new Promise(function(a,t){return P({mediaType:"any",maxWidth:0,maxHeight:0,videoQuality:"high",durationLimit:0,quality:1,cameraType:"back",includeBase64:!1,includeExtra:!0,saveToPhotos:!1,selectionLimit:1},async function(e){if(e.didCancel)return t("Backup selection cancelled");if(e.errorCode)return t(`Native error: ${e.errorCode}`);const s=await fetch(e.assets[0].uri);let l;try{l=await s.json()}catch{return t("Malformed backup file")}a(l)})})},T=function(){return{settings:p.settings,...h.identity?.features?.loaderConfig&&{loaderConfig:h.config}}};async function D(a){const t={};for(const e of Object.values(o.plugins))t[e.id]={...e,...a&&{storage:await f.createMMKVBackend(e.id).get()??{}}};return t}function E(){const a={};for(const t of Object.values(d.themes))a[t.id]=t;return a}async function k(a){if(Object.keys(a).length===0)throw new Error("At least one option should be selected");if(a.pluginData&&!a.plugins)throw new Error("Plugin data cannot be backed up independently of plugins");const t={};return a.vendetta&&(t.vendetta=T()),a.plugins&&(t.plugins=await D(a.pluginData)),a.themes&&(t.themes=E()),t}function N(a){for(const t of Object.keys(a.settings))p.settings[t]=a.settings[t];if(a.loaderConfig)for(let t of Object.keys(a.settings))h.config[t]=a.loaderConfig[t]}async function S(a,t){for(const e of Object.values(a)){if(!o.plugins[e.id])await o.fetchPlugin(e.id).catch(function(){try{o.plugins[e.id]={id:e.id,manifest:e.manifest,enabled:e.enabled,update:e.update,js:e.js}}catch(s){c.showToast(`Failed to restore ${e.manifest.name}, ${s.message}`,r.getAssetIDByName("Small"))}});else try{o.stopPlugin(e.id)}catch(s){c.showToast(`Failed to stop ${e.manifest.name}, ${s.message}`,r.getAssetIDByName("Small"))}e.storage&&t&&await f.createMMKVBackend(e.id).set(e.storage),e.enabled&&await o.startPlugin(e.id).catch(function(s){return c.showToast(`Failed to start ${e.manifest.name}, ${s.message}`,r.getAssetIDByName("Small"))})}}async function I(a){for(const t of Object.values(a))d.themes[t.id]||await d.fetchTheme(t.id).catch(function(){try{d.themes[t.id]={id:t.id,selected:t.selected,data:t.data}}catch(e){c.showToast(`Failed to restore ${t.data.name}, ${e.message}`,r.getAssetIDByName("Small"))}}),t.selected&&await d.selectTheme(t.id)}async function V(a,t){t.vendetta&&a.vendetta&&N(a.vendetta),t.plugins&&a.plugins&&await S(a.plugins,t.pluginData),t.themes&&a.themes&&await I(a.themes)}const{FormRow:u,FormSwitchRow:A,FormSection:F,FormDivider:x}=v.Forms,b=[{label:"Vendetta",subLabel:"Whether to include Vendetta's settings",icon:"settings",setting:"includeVendetta"},{label:"Plugins",subLabel:"Whether to include installed plugins",icon:"debug",setting:"includePlugins"},{label:"Plugin Data",subLabel:"Whether to include the data of installed plugins",icon:"ic_rulebook",setting:"backupPluginData",depends:"includePlugins"},{label:"Themes",subLabel:"Whether to include installed themes",icon:"ic_theme_24px",setting:"includeThemes"}];function $(){const[,a]=n.React.useReducer(function(e){return~e},0);f.useProxy(i.storage);const t=Object.values(i.storage).every(function(e){return!e});return n.React.createElement(n.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},b.map(function(e,s){return n.React.createElement(n.React.Fragment,null,n.React.createElement(A,{label:e.label,subLabel:e.subLabel,leading:e.icon&&n.React.createElement(u.Icon,{source:r.getAssetIDByName(e.icon)}),disabled:i.storage[e.depends]===!1,value:i.storage[e.setting],onValueChange:function(l){e.action?.(l),i.storage[e.setting]=l,l===!1&&(b.filter(function(m){return m.depends===e.setting}).forEach(function(m){return i.storage[m.setting]=!1}),a())}}),s!==b.length-1&&n.React.createElement(x,null))}),n.React.createElement(F,{title:"Actions"},n.React.createElement(u,{label:"Backup",leading:n.React.createElement(u.Icon,{source:r.getAssetIDByName("share")}),disabled:t,onPress:async function(){const e=await k({vendetta:i.storage.includeVendetta,plugins:i.storage.includePlugins,pluginData:i.storage.includePluginData,themes:i.storage.includeThemes}).catch(function(s){return c.showToast("Failed to create backup",r.getAssetIDByName("Small"))});n.ReactNative.Share.share({message:JSON.stringify(e),title:`vd-ms-backup-${Date.now()}`})}}),n.React.createElement(u,{label:"Restore",leading:n.React.createElement(u.Icon,{source:r.getAssetIDByName("ic_download_24px")}),disabled:t,onPress:function(){return B().then(async function(e){await V(e,{vendetta:i.storage.includeVendetta,plugins:i.storage.includePlugins,pluginData:i.storage.includePluginData,themes:i.storage.includeThemes}),c.showToast("Restored backup successfully.",r.getAssetIDByName("Check"))}).catch(function(e){return c.showToast(e,r.getAssetIDByName("Small"))})}})))}const{FormRow:R}=v.Forms;function j(){return n.React.createElement(n.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},n.React.createElement(R,{label:"Prox-ify plugins",subLabel:"This will move any installed plugins that are on the plugin proxy to their proxied versions.",leading:n.React.createElement(R.Icon,{source:r.getAssetIDByName("ic_globe_24px")}),onPress:function(){return c.showToast("Soon\u2122")}}))}const{BadgableTabBar:C}=g.findByProps("BadgableTabBar"),y=[{id:"backup_restore",title:"Backup and Restore",render:$},{id:"tools",title:"Tools",render:j}];function L(){const[a,t]=n.React.useState(y[0]);return n.React.createElement(n.ReactNative.View,{style:{flex:1}},n.React.createElement(n.ReactNative.View,{style:{margin:16}},n.React.createElement(C,{tabs:y,activeTab:a.id,onTabSelected:function(e){const s=y.find(function(l){return l.id===e});s&&(s.onPress?.(s.id),s.render&&t(s))}})),n.React.createElement(a.render,null))}return i.storage.includeVendetta??=!0,i.storage.includePlugins??=!0,i.storage.includePluginData??=!0,i.storage.includeThemes??=!0,w.settings=L,w})({},vendetta.plugin,vendetta.metro,vendetta.metro.common,vendetta.storage,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta,vendetta.loader,vendetta.plugins,vendetta.themes);
