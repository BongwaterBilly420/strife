(function(w,i,t,h,r,l,v,k,b,u,d,y,P){"use strict";const T=function(){return{settings:k.settings,...b.identity?.features?.loaderConfig&&{loaderConfig:b.config}}};async function N(a){const e={};for(const n of Object.values(u.plugins))e[n.id]={...n,...a&&{storage:await h.createMMKVBackend(n.id).get()??{}}};return e}function D(){const a={};for(const e of Object.values(d.themes))a[e.id]=e;return a}async function S(a){if(Object.keys(a).length===0)throw new Error("At least one option should be selected");if(a.pluginData&&!a.plugins)throw new Error("Plugin data cannot be backed up independently of plugins");const e={};return a.vendetta&&(e.vendetta=T()),a.plugins&&(e.plugins=await N(a.pluginData)),a.themes&&(e.themes=D()),e}function I(a){for(const e of Object.keys(a.settings))k.settings[e]=a.settings[e];if(a.loaderConfig)for(let e of Object.keys(a.settings))b.config[e]=a.loaderConfig[e]}async function B(a,e){for(const n of Object.values(a)){if(!u.plugins[n.id])await u.fetchPlugin(n.id).catch(function(){try{u.plugins[n.id]={id:n.id,manifest:n.manifest,enabled:n.enabled,update:n.update,js:n.js}}catch(s){l.showToast(`Failed to restore ${n.manifest.name}, ${s.message}`,r.getAssetIDByName("Small"))}});else try{u.stopPlugin(n.id)}catch(s){l.showToast(`Failed to stop ${n.manifest.name}, ${s.message}`,r.getAssetIDByName("Small"))}n.storage&&e&&await h.createMMKVBackend(n.id).set(n.storage),n.enabled&&await u.startPlugin(n.id).catch(function(s){return l.showToast(`Failed to start ${n.manifest.name}, ${s.message}`,r.getAssetIDByName("Small"))})}}async function A(a){for(const e of Object.values(a))d.themes[e.id]||await d.fetchTheme(e.id).catch(function(){try{d.themes[e.id]={id:e.id,selected:e.selected,data:e.data}}catch(n){l.showToast(`Failed to restore ${e.data.name}, ${n.message}`,r.getAssetIDByName("Small"))}}),e.selected&&await d.selectTheme(e.id)}async function C(a,e){e.vendetta&&a.vendetta&&I(a.vendetta),e.plugins&&a.plugins&&await B(a.plugins,e.pluginData),e.themes&&a.themes&&await A(a.themes)}const{launchImageLibrary:x}=y.findByProps("launchImageLibrary");y.findByProps("downloadMediaAsset");const V=function(){return new Promise(function(a,e){return x({mediaType:"any",maxWidth:0,maxHeight:0,videoQuality:"high",durationLimit:0,quality:1,cameraType:"back",includeBase64:!1,includeExtra:!0,saveToPhotos:!1,selectionLimit:1},async function(n){if(n.didCancel)return e("Backup selection cancelled");if(n.errorCode)return e(`Native error: ${n.errorCode}`);const s=await fetch(n.assets[0].uri);let o;try{o=await s.json()}catch{return e("Malformed backup file")}a(o)})})},F=t.stylesheet.createThemedStyleSheet({header:{color:P.semanticColors.HEADER_PRIMARY,fontSize:32,fontFamily:"ggsans-Semibold, NotoSans-Semibold",textAlign:"center",lineHeight:40}});function L(a){let{children:e}=a;return React.createElement(t.ReactNative.Text,{style:F.header},e)}const f=y.findByProps("Looks","Colors","Sizes"),g=t.stylesheet.createThemedStyleSheet({container:{flex:1,justifyContent:"space-between"},textContainer:{marginTop:24,alignItems:"center"},imageContainer:{justifyContent:"center",alignItems:"center"},image:{width:256,height:256,resizeMode:"contain"},buttonsContainer:{padding:24}}),{FormText:j}=v.Forms;function $(a){let{headerText:e,bodyText:n,buttons:s}=a;return t.React.createElement(t.ReactNative.View,{style:g.container},t.React.createElement(t.ReactNative.View,{style:g.textContainer},t.React.createElement(L,null,e),t.React.createElement(j,null,n),t.React.createElement(t.ReactNative.View,{style:g.imageContainer},t.React.createElement(t.ReactNative.Image,{source:r.getAssetIDByName("img-wumpus-wave"),style:g.image}))),t.React.createElement(t.ReactNative.View,{style:g.buttonsContainer},s.map(function(o){return t.React.createElement(f,{color:f.Colors.BRAND,size:f.Sizes.MEDIUM,look:f.Looks.FILLED,onPress:o.onPress,text:o.text})})))}const{FormRow:c,FormSwitchRow:M,FormSection:E,FormDivider:O}=v.Forms,p=[{label:"Vendetta",subLabel:"Whether to backup Vendetta's settings",icon:"settings",setting:"backupVendetta"},{label:"Plugins",subLabel:"Whether to backup installed plugins",icon:"debug",setting:"backupPlugins"},{label:"Plugin Data",subLabel:"Whether to backup the data of installed plugins",icon:"ic_rulebook",setting:"backupPluginData",depends:"backupPlugins"},{label:"Themes",subLabel:"Whether to backup installed themes",icon:"ic_theme_24px",setting:"backupThemes"}];function _(){const[,a]=t.React.useReducer(function(s){return~s},0),e=t.NavigationNative.useNavigation();h.useProxy(i.storage);const n=Object.values(i.storage).every(function(s){return!s});return t.React.createElement(t.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},t.React.createElement(E,{title:"Options",titleStyleType:"no_border"},p.map(function(s,o){return t.React.createElement(t.React.Fragment,null,t.React.createElement(M,{label:s.label,subLabel:s.subLabel,leading:s.icon&&t.React.createElement(c.Icon,{source:r.getAssetIDByName(s.icon)}),disabled:i.storage[s.depends]===!1,value:i.storage[s.setting],onValueChange:function(m){s.action?.(m),i.storage[s.setting]=m,m===!1&&(p.filter(function(R){return R.depends===s.setting}).forEach(function(R){return i.storage[R.setting]=!1}),a())}}),o!==p.length-1&&t.React.createElement(O,null))})),t.React.createElement(E,{title:"Actions"},t.React.createElement(c,{label:"Backup",leading:t.React.createElement(c.Icon,{source:r.getAssetIDByName("share")}),disabled:n,onPress:async function(){const s=await S({vendetta:i.storage.backupVendetta,plugins:i.storage.backupPlugins,pluginData:i.storage.backupPluginData,themes:i.storage.backupThemes}).catch(function(o){return l.showToast("Failed to create backup",r.getAssetIDByName("Small"))});t.ReactNative.Share.share({message:JSON.stringify(s,null,4),title:`vd-ms-backup-${Date.now()}`})}}),t.React.createElement(c,{label:"Restore",leading:t.React.createElement(c.Icon,{source:r.getAssetIDByName("ic_download_24px")}),disabled:n,onPress:function(){return V().then(async function(s){await C(s,{vendetta:i.storage.backupVendetta,plugins:i.storage.backupPlugins,pluginData:i.storage.backupPluginData,themes:i.storage.backupThemes}),l.showToast("Restored backup successfully.",r.getAssetIDByName("Check"))}).catch(function(s){return l.showToast(s,r.getAssetIDByName("Small"))})}}),t.React.createElement(c,{label:"Tools",leading:t.React.createElement(c.Icon,{source:r.getAssetIDByName("ic_badge_staff")}),trailing:t.React.createElement(c.Arrow,null),onPress:function(){return l.showToast("TODO",r.getAssetIDByName("img_none"))}}),t.React.createElement(c,{label:"TESTING: Show Summary Page",leading:t.React.createElement(c.Icon,{source:r.getAssetIDByName("settings")}),trailing:t.React.createElement(c.Arrow,null),onPress:function(){return e.push("VendettaCustomPage",{title:"Summary",render:function(){return t.React.createElement($,{headerText:"Backup Success",bodyText:"All done!",buttons:[{text:"Reload",onPress:function(){return t.ReactNative.NativeModules.BundleUpdaterManager.reload()}}]})}})}})))}return i.storage.backupVendetta??=!0,i.storage.backupPlugins??=!0,i.storage.backupPluginData??=!0,i.storage.backupThemes??=!0,w.settings=_,w})({},vendetta.plugin,vendetta.metro.common,vendetta.storage,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta,vendetta.loader,vendetta.plugins,vendetta.themes,vendetta.metro,vendetta.ui);
