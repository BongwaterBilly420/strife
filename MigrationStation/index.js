(function(m,n,s,d,c,i,k,p,g,l,u,w){"use strict";const v=function(){return{settings:p.settings,...g.identity?.features?.loaderConfig&&{loaderConfig:g.config}}};async function D(a){const t={};for(const e of Object.values(l.plugins))t[e.id]={...e,...a&&{storage:await d.createMMKVBackend(e.id).get()??{}}};return t}function R(){const a={};for(const t of Object.values(u.themes))a[t.id]=t;return a}async function P(a){if(Object.keys(a).length===0)throw new Error("At least one option should be selected");if(a.pluginData&&!a.plugins)throw new Error("Plugin data cannot be backed up independently of plugins");const t={};return a.vendetta&&(t.vendetta=v()),a.plugins&&(t.plugins=await D(a.pluginData)),a.themes&&(t.themes=R()),t}function T(a){for(const t of Object.keys(a.settings))p.settings[t]=a.settings[t];if(a.loaderConfig)for(let t of Object.keys(a.settings))g.config[t]=a.loaderConfig[t]}async function I(a,t){for(const e of Object.values(a)){if(!l.plugins[e.id])await l.fetchPlugin(e.id,!1).catch(function(){try{l.plugins[e.id]={id:e.id,manifest:e.manifest,enabled:e.enabled,update:e.update,js:e.js}}catch(o){i.showToast(`Failed to restore ${e.manifest.name}, ${o.message}`,c.getAssetIDByName("Small"))}});else try{l.stopPlugin(e.id)}catch(o){i.showToast(`Failed to stop ${e.manifest.name}, ${o.message}`,c.getAssetIDByName("Small"))}e.storage&&t&&await d.createMMKVBackend(e.id).set(e.storage),e.enabled&&await l.startPlugin(e.id).catch(function(o){return i.showToast(`Failed to start ${e.manifest.name}, ${o.message}`,c.getAssetIDByName("Small"))})}}async function B(a){for(const t of Object.values(a))u.themes[t.id]||await u.fetchTheme(t.id).catch(function(){try{u.themes[t.id]={id:t.id,selected:t.selected,data:t.data}}catch(e){i.showToast(`Failed to restore ${t.data.name}, ${e.message}`,c.getAssetIDByName("Small"))}}),t.selected&&await u.selectTheme(t.id)}async function E(a,t){t.vendetta&&a.vendetta&&T(a.vendetta),t.plugins&&a.plugins&&await I(a.plugins,t.pluginData),t.themes&&a.themes&&await B(a.themes)}const{FormRow:r,FormSwitchRow:A,FormSection:y,FormDivider:N}=k.Forms,b=[{label:"Vendetta",subLabel:"Whether to backup Vendetta's settings",icon:"settings",setting:"backupVendetta"},{label:"Plugins",subLabel:"Whether to backup installed plugins",icon:"debug",setting:"backupPlugins"},{label:"Plugin Data",subLabel:"Whether to backup the data of installed plugins",icon:"ic_rulebook",setting:"backupPluginData",depends:"backupPlugins"},{label:"Themes",subLabel:"Whether to backup installed themes",icon:"ic_theme_24px",setting:"backupThemes"}];function O(){const[,a]=s.React.useReducer(function(e){return~e},0);d.useProxy(n.storage);const t=Object.values(n.storage).every(function(e){return!e});return s.React.createElement(s.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},s.React.createElement(y,{title:"Options",titleStyleType:"no_border"},b.map(function(e,o){return s.React.createElement(s.React.Fragment,null,s.React.createElement(A,{label:e.label,subLabel:e.subLabel,leading:e.icon&&s.React.createElement(r.Icon,{source:c.getAssetIDByName(e.icon)}),disabled:n.storage[e.depends]===!1,value:n.storage[e.setting],onValueChange:function(f){e.action?.(f),n.storage[e.setting]=f,f===!1&&(b.filter(function(h){return h.depends===e.setting}).forEach(function(h){return n.storage[h.setting]=!1}),a())}}),o!==b.length-1&&s.React.createElement(N,null))})),s.React.createElement(y,{title:"Actions"},s.React.createElement(r,{label:"Backup",leading:s.React.createElement(r.Icon,{source:c.getAssetIDByName("share")}),disabled:t,onPress:async function(){const e=await P({vendetta:n.storage.backupVendetta,plugins:n.storage.backupPlugins,pluginData:n.storage.backupPluginData,themes:n.storage.backupThemes}).catch(function(o){return i.showToast("Failed to create backup",c.getAssetIDByName("Small"))});s.clipboard.setString(JSON.stringify(e)),i.showToast("Copied backup data to clipboard.",c.getAssetIDByName("Check"))}}),s.React.createElement(r,{label:"Restore",leading:s.React.createElement(r.Icon,{source:c.getAssetIDByName("ic_download_24px")}),disabled:t,onPress:function(){return w.showInputAlert({title:"Input Backup Data",confirmText:"Restore",cancelText:"Cancel",onConfirm:async function(e){await E(JSON.parse(e),{vendetta:n.storage.backupVendetta,plugins:n.storage.backupPlugins,pluginData:n.storage.backupPluginData,themes:n.storage.backupThemes}),i.showToast("Restored backup successfully.",c.getAssetIDByName("Check"))}})}}),s.React.createElement(r,{label:"Tools",leading:s.React.createElement(r.Icon,{source:c.getAssetIDByName("ic_badge_staff")}),trailing:s.React.createElement(r.Arrow,null),onPress:function(){return i.showToast("TODO",c.getAssetIDByName("img_none"))}})))}return n.storage.backupVendetta??=!0,n.storage.backupPlugins??=!0,n.storage.backupPluginData??=!0,n.storage.backupThemes??=!0,m.settings=O,m})({},vendetta.plugin,vendetta.metro.common,vendetta.storage,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta,vendetta.loader,vendetta.plugins,vendetta.themes,vendetta.ui.alerts);
